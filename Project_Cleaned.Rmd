---
title: "Dog Adoption"
author: "Tyler Mallon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package_load, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
# Clear packages 
if(is.null(sessionInfo()$otherPkgs) == FALSE)lapply(
  paste("package:", names(sessionInfo()$otherPkgs), sep=""), 
  detach, character.only = TRUE, unload = TRUE)

# Clear environment
rm(list = ls(all = TRUE)) 

# If do not have the packages listed below, you must install them.
# tidyverse
# caret
# ggthemes
# ranger

library(tidyverse)
library(caret)
library(ggthemes)
library(recipes)
library(ggridges)
library(viridis)
```

```{r data_import, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
data <- read_csv("aac_intakes_outcomes.csv")
```

### Introduction & Background

The Austin Animal Center (AAC) is the largest no-kill municipal animal shelter in the United States. They are an open-intake facility providing shelter and protection to all animals regardless of their condition upon intake. They seek to only euthanize a maximum of 10% of the animals they receive, and usually do so only as a means of ending suffering. The goal of the AAC is to place all animals that can be adopted into permanent homes. As such, the primary goal of this research is to help the AAC to better predict whether an animal can be adopted based upon an analysis of previous AAC data observations. This should help the AAC better optimize the use of its limited resources by prolonging the sheltering of animals most likely to be adopted (or returned).

***

### EDA Overview

Although there were a few other outcome types observed in the shelter population, after performing an exploratory data analysis (EDA), I decided to limit the sample set to animals with the four most prevalent outcome types; Adoption, Euthanasia, Return to Owner, and Transfer. Additionally, I decided to focus this effort initially on just predicting the outcomes of dogs. This is based on the fact that dogs comprise 56.9% of all observations. I suspect that separate models should be created for different animal types, and as such I want to focus on one species of animal to begin with. The EDA confirmed several of my initial intuitions. First, owners prefer not to adopt dogs that still have their reproductive capabilities still intact. Second, owners prefer to adopt younger dogs. Third and finally, Owners prefer to adopt dogs that are in good health. 

I also discovered that it was going to be necessary to simplify several of the features due to the number of distinct values that they contained. Both color and dog breed contained over 300 distinct values, which would be computationally very expensive. After doing some research on the adoption of dogs in general, I discovered that there is a prevailing theory that black colored dogs seem to be adopted less. So, I decided to simplify the color variable as either black or not. Similar to "color," I reduced the number of possible breed values by grouping all the breeds into the eight different groups as defined by the AKC [here](https://www.akc.org/public-education/resources/general-tips-information/dog-breeds-sorted-groups/). These are broken down into seven primary categories of dogs, and one miscellaneous category for any dog that does not fall under those seven primary groupings. 

#### EDA Process - Initial Dataset Variables

In the initial dataset, there are 10 different possible values of outcome type which are listed below:

```{r variable_exploration1, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  select(outcome_type) %>%
  distinct(.)
```

In the initial dataset, there are 20 different possible values of outcome subtype which are listed below:

```{r variable_exploration2, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  select(outcome_subtype) %>%
  distinct(.)
```

In the initial dataset, there are 6 different possible values of reproductive status which are listed below:

```{r variable_exploration3, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  select(sex_upon_outcome) %>%
  distinct(.)
```

In the initial dataset, there are 5 different possible values of intake type which are listed below:

```{r variable_exploration4, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  select(intake_type) %>%
  distinct(.)
```

In the initial dataset, there are 8 different possible values of the animal's health status which are listed below:

```{r variable_exploration5, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  select(intake_condition) %>%
  distinct(.)
```

In the initial dataset, it appears that almost all of the animals are cats and dogs. A minor amount of other animal types are present.

```{r variable_exploration6, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  group_by(animal_type) %>%
  summarise(counts = n())
```

In the initial dataset, it appears that there are 1919 unique breeds of dogs.

```{r variable_exploration7, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  filter(animal_type == "Dog") %>%
  select(breed) %>%
  distinct(.)
```

In the initial dataset, there are 337 unique color combinations of dogs.

```{r variable_exploration8, echo = FALSE, message = FALSE, warning = FALSE}
data %>%
  filter(animal_type == "Dog") %>%
  select(color) %>%
  distinct(.)
```

#### EDA Process - Initial Variable Relationhips

```{r}
data_dog <- data %>%
  filter(animal_type == "Dog")
```

It appears that there are four primary outcomes: Adoption, Transfer, Return to Owner, and Euthanasia. I plan to limit the model predictions to only these four outcomes as there is insufficient data on the other outcomes. I'm curious now to examine the relationship the other variables have with the four largest classes of out comecome type.

```{r distributional_exploration1, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  group_by(outcome_type) %>%
  summarise(outcome_num = n()) %>%
  na.omit(.) %>%
  ggplot(aes(x = reorder(outcome_type, outcome_num), y = outcome_num)) +
  geom_bar(stat = "identity", fill = "dodgerblue") +
  coord_flip() +
  labs(x = "Shelter Outcome", y = "Outcome Count", title = "Top 4 outcomes comprise almost all of total outcomes", subtitle = "Euthanasia represents the smallest outcome and is likely attributable to the no-kill mission") +
  theme_minimal()
```

In the initial dataset, almost all the animals have only visited the shelter once. A small portion of the animals have been to the shelter twice and there are almost no animals that have been there three or more times. 

```{r distributional_exploration2, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  group_by(animal_id_intake) %>%
  summarise(times = max(intake_number)) %>%
  ggplot(aes(x = times)) +
  geom_histogram(fill = "dodgerblue") +
  labs(x = "Lifetime Visits To Shelter Per Animal", y = "Outcome Count", title = "Dogs typically do not stay in the shelter more than 3 times") +
  theme_minimal()
```

```{r distributional_exploration3, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia")) %>%
  group_by(animal_id_intake, outcome_type) %>%
  summarise(times = max(intake_number), count = n()) %>%
  ggplot(aes(x = times, y = count)) +
  geom_bar(stat = "identity", fill = "dodgerblue") +
  facet_grid(. ~ outcome_type) +
  labs(x = "Lifetime Visits To Shelter Per Animal", y = "Outcome Count", title = "Dogs typically do not stay in the shelter more than 3 times") +
  theme_minimal()
```

The distributions for dogs across the primary outcomes of Adoption, Return to Owner, and Transfer are fairly similar. They are all right skewed distributions and appear to reflect the overall distribution of the age of dogs within the shelter. Euthanasia, however, differs slightly and shows a distribution closer to uniform with a slight central tendency around age of year 2.

```{r distributional_exploration4, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia")) %>%
  ggplot(aes(x = `age_upon_outcome_(years)`)) +
  geom_histogram(bins = 20, fill = "dodgerblue") +
  facet_grid(. ~ outcome_type) +
  labs(x = "Age Upon Outcome in Years", y = "Outcome Count", title = "Animals are typically younger when adopted", subtitle = "Distributions between Euthanasia and other 3 primary classes appear different") +
  theme_minimal()
```

As a proportion of the possible outcomes, it is clear that spayed and neutered dogs are almost all of the animals that end up getting adopted. Spayed and neutered dogs also comprise a majority of dogs that result in the Return to Owner outcome. The distribution is more even for the Euthanasia and Transfer outcomes. I also see that male dogs comprise a slightly higher proportion of euthanized dogs relative to females.

```{r distributional_exploration5, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia") & (sex_upon_outcome != "NULL")) %>%
  group_by(outcome_type, sex_upon_outcome) %>%
  summarise(counts = n()) %>%
  group_by(outcome_type) %>%
  mutate(freq = counts/sum(counts)) %>%
  ggplot(aes(x = sex_upon_outcome, y = freq)) +
  geom_bar(stat = "identity", fill = "dodgerblue") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ outcome_type, nrow = 2) +
  coord_flip() +
  labs(x = "Reproductive Status", y = "Percent of Outcome Total", title = "Almost all adopted dogs are Spayed or Neutered", subtitle = "Male dogs appear to be more likely to be euthanized than female dogs") +
  theme_minimal()
```

As a proportion of the possible outcomes for all adopted dogs, their intake status is almost always Normal. For euthanized dogs, intake status of Normal is still the predominant intake status. However, euthanized dogs have a much higher percentage of injured and sick dogs relative to adopted dogs. This is generally what I expect.

```{r distributional_exploration6, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia") & (sex_upon_outcome != "NULL")) %>%
  group_by(outcome_type, intake_condition) %>%
  summarise(counts = n()) %>%
  group_by(outcome_type) %>%
  mutate(freq = counts/sum(counts)) %>%
  ggplot(aes(x = intake_condition, y = freq)) +
  geom_bar(stat = "identity", fill = "dodgerblue") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ outcome_type, nrow = 2) +
  coord_flip() +
  labs(x = "Intake Condition", y = "Percent of Outcome Total", title = "Dogs with an intake status other than Normal typically aren't adopted", subtitle = "Sick and injured dogs more likely to be euthanized than other outcomes") +
  theme_minimal()
```

The time spent in shelter for each outcome type shows that the euthanasia and return to owner outcomes are much more likely to occur within the first several days of stay than adoption and transfer outcomes. This seems to make sense, as the dogs that are euthanized are usually done so for medical reasons and a dog that is returned to its owner seems to be a result of the owner regretting their decision to give up the dog. Interestingly, dogs are most commonly adopted or transfered within two weeks of their arrival to the shelter. This provides some context on how long it usually takes for the most desirable animals to be adopted or transfered.

```{r distributional_exploration7, echo = FALSE, message = FALSE, warning = FALSE}
data_dog %>%
  filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia") & (sex_upon_outcome != "NULL") & (time_in_shelter_days <= 100)) %>%
ggplot(aes(x=time_in_shelter_days, y=as.factor(outcome_type), fill=factor(..quantile..))) +
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantiles = 4, quantile_lines = TRUE) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "C") +
  labs(title = "Return to Owner and Euthanasia outcomes typically occur within\nthe first several days of stay",
       subtitle = "Adoption and Transfer outcomes have mean outcome around one week of stay",
       x = "Days Spent In Shelter", y = "Outcome Type") +
  theme_minimal()
```

```{r data_cleaning, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# ======================================= #
# Converting Dog Breed To AKC Breed Group
# ======================================= #

data_dog <- data %>%
  filter(animal_type == "Dog") %>%
  mutate(breed = tolower(breed))

breeds <- str_split(data_dog$breed, pattern = "/")
breeds <- as.data.frame(t(sapply(breeds, '[', seq(max(sapply(breeds, length))))))

data_dog <- cbind(data_dog, breeds)

data_dog$V1 <- gsub("mix", "", data_dog$V1)
data_dog$V2 <- gsub("mix", "", data_dog$V2)
data_dog$V3 <- gsub("mix", "", data_dog$V3)

data_dog$V1 <- gsub(" dog", "", data_dog$V1)
data_dog$V2 <- gsub(" dog", "", data_dog$V2)
data_dog$V3 <- gsub(" dog", "", data_dog$V3)

trim.trailing <- function (x) sub("\\s+$", "", x)

data_dog$V1 <- trim.trailing(data_dog$V1)
data_dog$V2 <- trim.trailing(data_dog$V2)
data_dog$V3 <- trim.trailing(data_dog$V3)

data_dog <- data_dog %>%
  mutate(dog_type1 = ifelse(
    grepl("australian cattle|australian shepherd|bearded collie|beauceron|belgian malinois|belgian sheepdog|belgian tervuren|bergamasco|berger picard|border collie|bouvier des flandres|briard|canaan|cardigan welsh corgi|collie|entlebucher mountain|finnish lapphund|german shepherd|icelandic sheepdog|miniature american shepherd|norwegian buhund|old english sheepdog|pembroke welsh corgi|polish lowland sheepdog|puli|pumi|pyrenean shepherd|shetland sheepdog|spanish water dog|swedish vallhund", x = data_dog$V1), "Herding Group",
    ifelse(
      grepl("afghan hound|american english coonhound|american foxhound|basenji|basset hound|beagle|black and tan coonhound|bloodhound|bluetick coonhound|borzoi|cirneco dell'etna|dachsund|english foxhound|greyhound|harrier|ibizan hound|irish wolfhound|norwegian elkhound|otterhound|petit basset griffon vendeen|pharoah hound|plott|portuguese podengo pequeno|redbone coonhound|rhodesian ridgeback|saluki|scottish deerhound|sloughi|treeing walker coonhound|whippet", x = data_dog$V1), "Hound Group",
      ifelse(
        grepl("affenpinscher|brussels griffon|cavalier king charles spaniel|chihuahua|chinese crested|eng toy spaniel|havanese|italian greyhound|japanese chin|maltese|manchester terrier|miniature pinscher|papillon|pekingese|pomeranian|toy poodle|miniature poodle|pug|shih tzu|silky terrier|toy fox terrier|yorkshire terrier", x = data_dog$V1), "Toy Group",
        ifelse(
          grepl("american eskimo|bichon frise|boston terrier|bulldog|chinese shar-pei|chow chow|coton de tulear|dalmatian|finish spitz|french bulldog|keeshond|lhasa apso|lowchen|norwegian lundhund|poodle|schipperke|shiba inu|tibetan spaniel|tibetan terrier|xoloitzcuintli", x = data_dog$V1), "Non-Sporting Group",
          ifelse(
            grepl("american water spaniel|boykin spaniel|brittany|chesapeake bay retriever|clumber spaniel|cocker spaniel|curly-coated retriever|english cocker spaniel|english setter| english springer spaniel|field spaniel|flat-coated retriever|german shorthaired pointer|german wirehaired pointer|golden retriever|gordon setter|irish red and white setter|irish setter|irish water spaniel|labrador retriever|lagotto romagnolo|nova scotia duck tolling retriever|pointer|spinone italiano|sussex spaniel|vizsla|weimaraner|welsh springer spaniel|wirehaired pointing griffon|wirehaired vizsla", x = data_dog$V1), "Sporting Group",
            ifelse(
              grepl("airedale terrier|american hairless terrier|american staffordshire terrier|australian terrier|bedlington terrier|border terrier|bull terrier|cairn terrier|cesky terrier|dandie dinmont terrier|glen of imaal terrier|irish terrier|kerry blue terrier|lakeland terrier|manchester terrier|bull terrier miniature|miniature schnauzer|norfolk terrier|norwich terrier|parson russell terrier|rat terrier|russell terrier|scottish terrier|sealyham terrier|skye terrier|smooth fox terrier|staffordshire bull terrier|welsh terrier|west highland white terrier|wire hair fox terrier", x = data_dog$V1), "Terrier Group",
              ifelse(
                grepl("akita|alaskan malamute|anatolian shepherd dog|bernese mountain dog|black russian terrier|boerboel|boxer|bullmastiff|cane corso|chinook|doberman pinscher|dogue de bordeaux|german pinscher|giant schnauzer|great dane|great pyrenees|greater swiss mountain dog|komondor|kuvasz|leonberger|mastiff|neapolitan mastiff|newfoundland|portuguese water dog|rottweiler|samoyed|siberian husky|standard schnauzer|tibetan mastiff|st. bernard rough coat|st. bernard smooth coat", x = data_dog$V1), "Working Group", 
                ifelse(is.na(data_dog$V1), NA, "Miscelaneous Group")
                )
              )
            )
          )
        )
      )
    )
  )

data_dog <- data_dog %>%
  mutate(dog_type2 = ifelse(
    grepl("australian cattle|australian shepherd|bearded collie|beauceron|belgian malinois|belgian sheepdog|belgian tervuren|bergamasco|berger picard|border collie|bouvier des flandres|briard|canaan|cardigan welsh corgi|collie|entlebucher mountain|finnish lapphund|german shepherd|icelandic sheepdog|miniature american shepherd|norwegian buhund|old english sheepdog|pembroke welsh corgi|polish lowland sheepdog|puli|pumi|pyrenean shepherd|shetland sheepdog|spanish water dog|swedish vallhund", x = data_dog$V2), "Herding Group",
    ifelse(
      grepl("afghan hound|american english coonhound|american foxhound|basenji|basset hound|beagle|black and tan coonhound|bloodhound|bluetick coonhound|borzoi|cirneco dell'etna|dachsund|english foxhound|greyhound|harrier|ibizan hound|irish wolfhound|norwegian elkhound|otterhound|petit basset griffon vendeen|pharoah hound|plott|portuguese podengo pequeno|redbone coonhound|rhodesian ridgeback|saluki|scottish deerhound|sloughi|treeing walker coonhound|whippet", x = data_dog$V2), "Hound Group",
      ifelse(
        grepl("affenpinscher|brussels griffon|cavalier king charles spaniel|chihuahua|chinese crested|eng toy spaniel|havanese|italian greyhound|japanese chin|maltese|manchester terrier|miniature pinscher|papillon|pekingese|pomeranian|toy poodle|miniature poodle|pug|shih tzu|silky terrier|toy fox terrier|yorkshire terrier", x = data_dog$V2), "Toy Group",
        ifelse(
          grepl("american eskimo|bichon frise|boston terrier|bulldog|chinese shar-pei|chow chow|coton de tulear|dalmatian|finish spitz|french bulldog|keeshond|lhasa apso|lowchen|norwegian lundhund|poodle|schipperke|shiba inu|tibetan spaniel|tibetan terrier|xoloitzcuintli", x = data_dog$V2), "Non-Sporting Group",
          ifelse(
            grepl("american water spaniel|boykin spaniel|brittany|chesapeake bay retriever|clumber spaniel|cocker spaniel|curly-coated retriever|english cocker spaniel|english setter| english springer spaniel|field spaniel|flat-coated retriever|german shorthaired pointer|german wirehaired pointer|golden retriever|gordon setter|irish red and white setter|irish setter|irish water spaniel|labrador retriever|lagotto romagnolo|nova scotia duck tolling retriever|pointer|spinone italiano|sussex spaniel|vizsla|weimaraner|welsh springer spaniel|wirehaired pointing griffon|wirehaired vizsla", x = data_dog$V2), "Sporting Group",
            ifelse(
              grepl("airedale terrier|american hairless terrier|american staffordshire terrier|australian terrier|bedlington terrier|border terrier|bull terrier|cairn terrier|cesky terrier|dandie dinmont terrier|glen of imaal terrier|irish terrier|kerry blue terrier|lakeland terrier|manchester terrier|bull terrier miniature|miniature schnauzer|norfolk terrier|norwich terrier|parson russell terrier|rat terrier|russell terrier|scottish terrier|sealyham terrier|skye terrier|smooth fox terrier|staffordshire bull terrier|welsh terrier|west highland white terrier|wire hair fox terrier", x = data_dog$V2), "Terrier Group",
              ifelse(
                grepl("akita|alaskan malamute|anatolian shepherd dog|bernese mountain dog|black russian terrier|boerboel|boxer|bullmastiff|cane corso|chinook|doberman pinscher|dogue de bordeaux|german pinscher|giant schnauzer|great dane|great pyrenees|greater swiss mountain dog|komondor|kuvasz|leonberger|mastiff|neapolitan mastiff|newfoundland|portuguese water dog|rottweiler|samoyed|siberian husky|standard schnauzer|tibetan mastiff|st. bernard rough coat|st. bernard smooth coat", x = data_dog$V2), "Working Group", 
                ifelse(is.na(data_dog$V2), NA, "Miscelaneous Group")
                )
              )
            )
          )
        )
      )
    )
  )

data_dog <- data_dog %>%
  mutate(dog_type3 = ifelse(
    grepl("australian cattle|australian shepherd|bearded collie|beauceron|belgian malinois|belgian sheepdog|belgian tervuren|bergamasco|berger picard|border collie|bouvier des flandres|briard|canaan|cardigan welsh corgi|collie|entlebucher mountain|finnish lapphund|german shepherd|icelandic sheepdog|miniature american shepherd|norwegian buhund|old english sheepdog|pembroke welsh corgi|polish lowland sheepdog|puli|pumi|pyrenean shepherd|shetland sheepdog|spanish water dog|swedish vallhund", x = data_dog$V3), "Herding Group",
    ifelse(
      grepl("afghan hound|american english coonhound|american foxhound|basenji|basset hound|beagle|black and tan coonhound|bloodhound|bluetick coonhound|borzoi|cirneco dell'etna|dachsund|english foxhound|greyhound|harrier|ibizan hound|irish wolfhound|norwegian elkhound|otterhound|petit basset griffon vendeen|pharoah hound|plott|portuguese podengo pequeno|redbone coonhound|rhodesian ridgeback|saluki|scottish deerhound|sloughi|treeing walker coonhound|whippet", x = data_dog$V3), "Hound Group",
      ifelse(
        grepl("affenpinscher|brussels griffon|cavalier king charles spaniel|chihuahua|chinese crested|eng toy spaniel|havanese|italian greyhound|japanese chin|maltese|manchester terrier|miniature pinscher|papillon|pekingese|pomeranian|toy poodle|miniature poodle|pug|shih tzu|silky terrier|toy fox terrier|yorkshire terrier", x = data_dog$V3), "Toy Group",
        ifelse(
          grepl("american eskimo|bichon frise|boston terrier|bulldog|chinese shar-pei|chow chow|coton de tulear|dalmatian|finish spitz|french bulldog|keeshond|lhasa apso|lowchen|norwegian lundhund|poodle|schipperke|shiba inu|tibetan spaniel|tibetan terrier|xoloitzcuintli", x = data_dog$V3), "Non-Sporting Group",
          ifelse(
            grepl("american water spaniel|boykin spaniel|brittany|chesapeake bay retriever|clumber spaniel|cocker spaniel|curly-coated retriever|english cocker spaniel|english setter| english springer spaniel|field spaniel|flat-coated retriever|german shorthaired pointer|german wirehaired pointer|golden retriever|gordon setter|irish red and white setter|irish setter|irish water spaniel|labrador retriever|lagotto romagnolo|nova scotia duck tolling retriever|pointer|spinone italiano|sussex spaniel|vizsla|weimaraner|welsh springer spaniel|wirehaired pointing griffon|wirehaired vizsla", x = data_dog$V3), "Sporting Group",
            ifelse(
              grepl("airedale terrier|american hairless terrier|american staffordshire terrier|australian terrier|bedlington terrier|border terrier|bull terrier|cairn terrier|cesky terrier|dandie dinmont terrier|glen of imaal terrier|irish terrier|kerry blue terrier|lakeland terrier|manchester terrier|bull terrier miniature|miniature schnauzer|norfolk terrier|norwich terrier|parson russell terrier|rat terrier|russell terrier|scottish terrier|sealyham terrier|skye terrier|smooth fox terrier|staffordshire bull terrier|welsh terrier|west highland white terrier|wire hair fox terrier", x = data_dog$V3), "Terrier Group",
              ifelse(
                grepl("akita|alaskan malamute|anatolian shepherd dog|bernese mountain dog|black russian terrier|boerboel|boxer|bullmastiff|cane corso|chinook|doberman pinscher|dogue de bordeaux|german pinscher|giant schnauzer|great dane|great pyrenees|greater swiss mountain dog|komondor|kuvasz|leonberger|mastiff|neapolitan mastiff|newfoundland|portuguese water dog|rottweiler|samoyed|siberian husky|standard schnauzer|tibetan mastiff|st. bernard rough coat|st. bernard smooth coat", x = data_dog$V3), "Working Group", 
                ifelse(is.na(data_dog$V3), NA, "Miscelaneous Group")
                )
              )
            )
          )
        )
      )
    )
  )

data_dog$dog_type2 <- ifelse(is.na(data_dog$dog_type2), "One Type", data_dog$dog_type2)
data_dog$dog_type3 <- ifelse(data_dog$dog_type2 == "One Type", "One Type",
                             ifelse(is.na(data_dog$dog_type3), "Two Types", data_dog$dog_type3))

data_dog <- data_dog %>%
  mutate(is_black = ifelse(grepl("Black", data_dog$color), 1, 0))

data_dog_mod <- data_dog %>% select(outcome_number, outcome_type, sex_upon_outcome, `age_upon_outcome_(days)`, age_upon_outcome_age_group, outcome_month, outcome_year, outcome_weekday, outcome_hour, intake_condition, intake_type, sex_upon_intake, time_in_shelter_days, dog_type1, dog_type2, dog_type3, is_black)

# cleaning further to only include 4 primary outcome types and removing "NULL" values. Small percent of observations
data_dog_mod <- data_dog_mod %>% filter((outcome_type == "Adoption" | outcome_type == "Transfer" | outcome_type == "Return to Owner" | outcome_type == "Euthanasia") & (sex_upon_outcome != "NULL" | sex_upon_intake != "NULL"))

# found some models wouldn't run with underscores in colnames, so removing them just in case
data_dog_mod <- data_dog_mod %>% mutate_if(is.character, as.factor)
colnames(data_dog_mod) <- gsub(pattern = "_", replacement = "", x = colnames(data_dog_mod))

# selecting final variable set to be used in modeling
data_dog_mod <- data_dog_mod %>% select(outcometype, outcomenumber, sexuponoutcome, `ageuponoutcome(days)`, ageuponoutcomeagegroup, outcomemonth, outcomeweekday, intakecondition, intaketype, sexuponintake, timeinshelterdays, dogtype1, dogtype2, dogtype3, isblack)

# convert variables to the proper type when necessary

data_dog_mod <- data_dog_mod %>%
  mutate(outcomenumber = as.factor(ifelse(data_dog_mod$outcomenumber >= 3, "3+",
                                          ifelse(data_dog_mod$outcomenumber == 1, "1", "2"))),
         isblack = as.factor(data_dog_mod$isblack),
         outcomemonth = as.factor(data_dog_mod$outcomemonth))

```

#### EDA Process - Modified Dataset Exploration

***

### Model Choice/Description

The statistical learning methods that we used to develop our models were K Nearest Neighbors (KNN) and Random Forests. The first models we ran were KNN models. We chose to use KNN because this method is nonparametric and allows us to develop a model without yet knowing the importance of specific variables or having to choose variables accordingly. Another reason we chose to use the KNN method is that it's easy to make modifications to this type of model, allowing us to produce a large number of potential models. This ease of modification comes from the fact that the only tuning parameter we need to just is the number of K. 

After developing the KNN models, we moved on to creating models using the Random Forest method. We chose this method because of its classifying power. Typical decision trees often have a high variance and thus can struggle when there are large differences in the dataset from which the model was initially trained on. Random Forests, however, circumvent this problem by using an ensemble approach of creating many trees and using the aggregate results of each tree as a combined output. Another relevant factor for choosing this method was its ability to provide in-model calculated variable-importance measures, allowing us to see which variables have the greatest impact on the outcomes rather than making educated guesses. The random forest method we have utilized returns the variable importance, scaled from 0 to 100 for each class of variable. In this model, the predictors that ended up having the most importance were the following: how long the dog had been at the shelter (this had an importance of 100), the age of the dog, the intake type of the dog (whether the dog was a stray, an owner surrender, a public assist, etc.), and the dog's sex upon outcome. Another slightly less important variable was the reproductive status of the dog upon intake (whether the dog had been "fixed" or not). The variables with the least amount of importance were breed type and our modified color variable identifying whether dog was black or not. 

***

```{r modelTrain, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide', include = FALSE, eval = FALSE}
## DONT RUN FOR QUICK EXPLORATION. TRAINING TIME IS SEVERAL HOURS ##
set.seed(1)

ddm_index <- createDataPartition(data_dog_mod$outcometype,
                    p = 0.7,
                    list = FALSE,
                    times = 1)

training_ddm <- data_dog_mod[ddm_index,]
testing_ddm<- data_dog_mod[-ddm_index,]

modelLookup("knn")

fit_control <- trainControl(method = "cv", number = 10, verboseIter = TRUE)

knn_grid <- expand.grid(k = c(1,3,5,7,9,11,13,15,17))

knn_fit <- train(outcometype ~ ., 
                data = training_ddm, 
                method = "knn",
                trControl = fit_control,
                tuneGrid = knn_grid)

knn_fit

probs3 <- predict(knn_fit, testing_ddm, type = "raw")
confusionMatrix(probs3, testing_ddm$outcometype, mode = "everything")

modelLookup("ranger")

fit_control <- trainControl(method = "cv", number = 10, verboseIter = TRUE)

rf_grid <- expand.grid(mtry = c(2, 3, 4, 5),
                      min.node.size = c(1, 3, 5),
                      splitrule = c("gini", "extratrees"))

rf_fit <- train(outcometype ~ ., 
                data = training_ddm, 
                method = "ranger",
                trControl = fit_control,
                tuneGrid = rf_grid,
                importance = "impurity")

rf_fit

probs <- predict(rf_fit, testing_ddm, type = "raw")
confusionMatrix(probs, testing_ddm$outcometype, mode = "everything")

varImp(rf_fit)

rf_grid2 <- expand.grid(mtry = c(5, 6, 7, 8),
                      min.node.size = c(5, 7),
                      splitrule = c("gini"))

rf_fit2 <- train(outcometype ~ ., 
                data = training_ddm, 
                method = "ranger",
                trControl = fit_control,
                tuneGrid = rf_grid2,
                importance = "impurity")

rf_fit2

probs2 <- predict(rf_fit2, testing_ddm, type = "raw")
confusionMatrix(probs2, testing_ddm$outcometype, mode = "everything")
```

```{r modelSave, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide', eval = FALSE, include = FALSE}
saveRDS(object = knn_fit, file = "knnmodel.rds")
saveRDS(object = rf_fit, file = "rfmodel1.rds" )
saveRDS(object = rf_fit2, file = "rfmodel2.rds")
```

```{r modelRead, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
knn_fit <- readRDS(file = "knnmodel.rds")
rf_fit <- readRDS(file = "rfmodel1.rds")
rf_fit2 <- readRDS(file = "rfmodel2.rds")
```

```{r modelAnalysis, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
ddm_index <- createDataPartition(data_dog_mod$outcometype,
                    p = 0.7,
                    list = FALSE,
                    times = 1)

training_ddm <- data_dog_mod[ddm_index,]
testing_ddm<- data_dog_mod[-ddm_index,]
```

### Results

#### KNN

The KNN model we produced performed relatively well, with the highest accuracy percentage coming in at 69.76% using a K value of 11. For our K values, we used only odd values up to 17. From outside research, using only odd values seemed to be an industry best practice when using KNN so that each point would have majority category rather than being evenly split between two categories. In addition to the accuracy measurement, the KNN model provides another variable, Kappa, which is a metric that compares observed accuracy with expected accuracy. A Kappa of >.75 is considered to be excellent, while a Kappa between .4 and .75 is considered fair to good. The KNN model with a K value of 11 also had one of the highest Kappa values of .52, a fair to good value, and was only separated by .001 from the highest Kappa value. 

```{r knnModel, echo = FALSE, message = FALSE, warning = FALSE}
knn_fit
```

```{r knnAccuracy, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(knn_fit) +
  theme_minimal()
```

#### Random Forest

After optimizing our KNN modeling, we developed a few Random Forest models in an attempt to improve our test accuracy, along with the model's Kappa value. For our first Random Forest model, we used a range of 2-5 for the number of random variables to select from at each break (mtry). In our first model, we saw that the test accuracy continually increased with each marginal increase in our mtry variable. The highest accuracy achieved in the first model was about 78.3%. Since the accuracy increased with each value of mtry, we decided to create a second model with even higher values of mtry in order to determine the highest practical level of accuracy that could be obtained, and the level of mtry at which the accuracy might begin to increase by only a negligible amount. Thus, our second model had mtry values of 5-8. In this second model we likewise observed that the highest accuracy and Kappa values were developed at an mtry of 8. The results indicated a direct relationship between mtry and accuracy. However, when graphing the increase of accuracy compared to the increase in mtry, we noted that the model accuracy began to plateau at an mtry value of 8. Accordingly, we chose to leave our models with a max mtry value of 8. The second Random Forest model achieved an accuracy of 79.5% with a Kappa value 67.4, both of which were much higher than the values of the first Random Forest model and the KNN model.  

```{r rf1Model, echo = FALSE, message = FALSE, warning = FALSE}
rf_fit
```

```{r rf1Accuracy, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(rf_fit) +
  theme_minimal() +
  ylim(0.55, 0.8)
```

```{r rf2Model, echo = FALSE, message = FALSE, warning = FALSE}
rf_fit2
```

```{r rf2Accuracy, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(rf_fit2) +
  theme_minimal() +
  ylim(0.55, 0.8)
```

```{r rf2Kappa, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(rf_fit2, metric = "Kappa") +
  theme_minimal()
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
probs2 <- predict(rf_fit2, testing_ddm, type = "raw")
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
confusionMatrix(probs2, testing_ddm$outcometype, mode = "everything")
```

#### Variable Importance

After producing the second Random Forest model, we decided to look at the statistics by class. We discovered that the most important variables in determining the outcome for dogs in the shelter are: how long the dog has been in the shelter (in days), how old the dog is, and the outcome hour. In addition to observing what the most significant variables were, we were able to look at the sensitivity and specificity of our models in predicting the outcome types. In the case of predicting adoptions, the sensitivity value relays the accuracy percentage of those dogs predicted to be adoptions that were truly adopted. Specificity, on the other hand, relays the percentage of dogs predicted to not be euthanized that were actually not euthanized. When taking these considerations into account, we see that our last model is particularly good at predicting when an animal won’t be euthanized (99% Specificity), or when an animal will be adopted (93% Sensitivity). 

```{r echo = FALSE, message = FALSE, warning = FALSE}
varImp(rf_fit2)
```


***

### Conclusion

After developing two primary types of models, and several modifications of both, we were able to produce a best-fit model that correctly predicted the outcome of a dog in the AAC shelter with about 80% accuracy, though not all outcomes were predicted equally. If the shelter looks to predict whether a dog will be adopted or not, we can predict with great accuracy whether it will be adopted. Additionally, if the shelter is contemplating euthanasia, our best-fit model is almost perfect at predicting when animals should not be euthanized. This is very applicable to our business question in that we can determine which dogs should be kept on hand for homes to adopt. This insight could also serve to prevent the unnecessary deaths of animals that won't need to be euthanized. 

A few modifications could be made to improve the performance of our modeling in the future. Though we chose to simplify both the color and breed variables in order to alleviate computational difficulty, our results seem to indicate that we may have been better served by allowing the original specificity to better determine any breeds or colors more or less likely to be adopted. In addition to this modification, we recognize that it may be impractical to utilize the variable of how long the dog has been in the shelter in order to predict the dog's future outcome on the day of its intake. This is because the number of days a dog will be in the shelter is unknown on the day of its intake. Creating a forecasting model that can predict how long a dog will be in the shelter would be helpful to supply a prediction for our model to use as the number of days that a dog will ultimately be in the shelter. Lastly, we only tried two different methods of classification. There are certainly other methods of classification that could perform well on a data set like this, for example, Linear or Quadratic Discriminant Analysis. 
